# エターナル仮想機械型Lisp

この記事は[進捗 Advent Calendar 2020](https://github.com/t-sin/shinchoku-advent-calendar-2020)の11日目の記事です。

今日こそは軽くいきます。

## 人生初Lispをつくった (前フリ)

自作言語をはじめてみようと思い (きっかけはわすれた)、Nimという言語で人生初のLisp処理系をつくってみました。そのこと自体は以下の記事たちに書かれています:

- [Nimに入門して簡単なアプリケーションを書くまで - octahedron](http://octahedron.hatenablog.jp/entry/2018/02/02/215112)
- [インタラクティブシなREPLをWebページ上に実装する - octahedron](http://octahedron.hatenablog.jp/entry/2018/02/02/233043)
- [木の実を埋めなかったので拾われないLisp - octahedron](http://octahedron.hatenablog.jp/entry/2018/02/22/022420)

初めてなので妄想が広がったけど関数オブジェクトよくわからなくて終わった記憶しかのこっていません。NimがJavaScriptにもコンパイルできる言語だったのでブラウザで動かしてみたりして楽しそうですね。このときの処理系はなんの変哲もない構文木インタプリタでしたが、感覚がまったくなかったのでかなり苦労した気がします。このリポジトリは目標達成という点では失敗でしたが関数オブジェクトつき電卓を実装できたし学びも大きく、満足して終わりました。

## 仮想機械化

これまでの進捗アドベントカレンダーの記事で何度か「仮想機械」の語が登場していますが、もちろん、つぎは憧れの仮想機械に挑戦しようと目論むわけです。中二病ですね。仮想機械について調べているとJVMとかスタックマシンとかForthとかに到達するわけですが、そのスタックマシンおよびForthに感銘を受けてなんとなく仮想機械のイメージができた (と当時は思っていた)ので、いっそ低レイヤーみを出すためにC言語でつくりはじめました。それがこのリポジトリです。

https://github.com/t-sin/wl

「nutslisp reloaded」。1つめのLispが「nutslisp」という名前でした。思ったほど大きくできなかった未練がたらたらの名前です。

## で、完成したの？

エターナルの海へと旅立っていきました。タイトルどおりに、です。

コミットログを眺めているのですが、3回ほど書き直しているようです。Cでオブジェクトをどう表現するか試行錯誤していたり、ハッシュテーブルを実装しようとして四苦八苦していたり (『みんなのデータ構造』から持ってきたなというコードがちらほら)、かと思いきや[VMの命令の設計がされていたり](https://github.com/t-sin/wl/commit/2bf1d19482b7e180442dcf0a7c2faf6aa2e75688) (これはたぶんLuaのソースコードを参考にしていた名残り)、[ええええええい死ねええええええええ](https://github.com/t-sin/wl/commit/742b29f96450c7156a1f1a8d8d2ccf1547268e07)…！！ そして[Forthを意識した、というかまんまなVMに変わったり](https://github.com/t-sin/wl/commit/97b29cb0adcf0f800300f44050702409af2d59c5)。

実装背景としてもうひとつ。ここ半年くらいでC11でつくっている[SciurusというCommon Lispもどき](https://github.com/t-sin/mark)に取り掛かる前の調査実装という側面もあったと思います。いちどに大きなものは作れない、ということをnutslispで学んでいたのですね。えらい。

## 余談

いくつかの過去リポジトリは見られるの恥づかしいのでプライベートにしてたんですが、このアドベントカレンダーのためにmake publicしています。身を切る思いがしています。ぐはあ。